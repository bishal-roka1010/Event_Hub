<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EventHub — Events</title>
<meta name="author" content="Your Team" />
<meta name="description" content="EventHub — discover, filter, and RSVP to local events.">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
<link rel="stylesheet" href="assets/css/styles.css" />
</head>
<body>
<header class="navbar navbar-expand-lg bg-body-tertiary shadow-sm sticky-top">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">Event<span class="text-primary">Hub</span></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
    <nav id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link active" aria-current="page" href="event.html">Events</a></li>
        <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
        <li class="nav-item"><a class="nav-link" href="manual.html">Contact Us</a></li>
        <li class="nav-item"><a class="nav-link" href="admin.html">Admin</a></li>
      </ul>
      <div class="d-flex gap-2">
        <button id="themeToggle" class="btn btn-outline-secondary btn-sm" type="button">Theme</button>
        <!-- point to register unless you have a dedicated login.html -->
        <a id="loginBtn" href="register.html" class="btn btn-primary btn-sm">Login</a>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm d-none" type="button">Logout</button>
      </div>
    </nav>
  </div>
</header>

<main class="container py-4">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
    <h1 class="h3 mb-0">All Events</h1>
    <div class="d-flex align-items-center gap-2">
      <div class="btn-group" role="group" aria-label="View">
        <button id="viewGrid" class="btn btn-outline-secondary active" type="button" title="Grid view"><i class="bi bi-grid"></i></button>
        <button id="viewList" class="btn btn-outline-secondary" type="button" title="List view"><i class="bi bi-list"></i></button>
      </div>
      <button id="resetBtn" class="btn btn-outline-secondary" type="button" title="Clear filters"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
    </div>
  </div>

  <div class="row g-2 align-items-end">
    <div class="col-md-4">
      <label class="form-label">Search</label>
      <input id="q" class="form-control" placeholder="Title or venue...">
    </div>
    <div class="col-md-2">
      <label class="form-label">From</label>
      <input id="dateFrom" type="date" class="form-control">
    </div>
    <div class="col-md-2">
      <label class="form-label">To</label>
      <input id="dateTo" type="date" class="form-control">
    </div>
    <div class="col-md-2">
      <label class="form-label">Sort</label>
      <select id="sort" class="form-select">
        <option value="date">Date</option>
        <option value="title">Title</option>
      </select>
    </div>
    <div class="col-md-2">
      <div class="form-check mt-4">
        <input class="form-check-input" type="checkbox" id="favOnly">
        <label class="form-check-label" for="favOnly"><i class="bi bi-star"></i> Favorites only</label>
      </div>
    </div>
  </div>

  <!-- Category chips (auto-generated) -->
  <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
    <div id="chips" class="d-flex flex-wrap gap-2"></div>
    <small id="resultInfo" class="text-muted">Loading…</small>
  </div>

  <!-- Results -->
  <div id="grid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 mt-2"></div>
  <div id="list" class="list-group mt-2 d-none"></div>

  <!-- Pagination -->
  <nav class="d-flex justify-content-between align-items-center mt-3" aria-label="Pagination">
    <button id="prev" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Prev</button>
    <span id="page" class="text-muted small">Page 1</span>
    <button id="next" class="btn btn-outline-secondary btn-sm">Next <i class="bi bi-arrow-right"></i></button>
  </nav>
</main>

<footer class="border-top mt-5">
  <div class="container py-4 d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
    <div class="d-flex align-items-center gap-2">
      <span class="fs-5 fw-bold">Event<span class="text-primary">Hub</span></span>
      <span class="text-muted">• “Seamless Events, Unforgettable Experiences”</span>
    </div>
    <div class="d-flex align-items-center gap-3">
      <a class="text-decoration-none" href="manual.html"><i class="bi bi-life-preserver me-1"></i>Help</a>
      <a class="text-decoration-none" href="about.html"><i class="bi bi-people me-1"></i>About</a>
      <a class="text-decoration-none" href="event.html"><i class="bi bi-calendar-event me-1"></i>Events</a>
    </div>
  </div>
</footer>

<!-- Quick View Modal -->
<div class="modal fade" id="quickView" tabindex="-1" aria-labelledby="quickViewLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="quickViewLabel">Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="quickViewBody">
        <!-- filled by JS -->
      </div>
      <div class="modal-footer">
        <a id="quickViewLink" href="#" class="btn btn-primary">Open details</a>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Page script -->
<script type="module">
  // ----- Utilities -----
  const esc = (s='') => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const isLoggedIn = () => !!localStorage.getItem('auth_token');
  function toast(msg){
    const el = document.createElement('div');
    el.className = 'toast align-items-center text-bg-primary border-0 position-fixed start-50 translate-middle-x shadow';
    el.style.zIndex = '2000';
    const nav = document.querySelector('.navbar.sticky-top');
    const offset = (nav ? nav.getBoundingClientRect().height : 56) + 12;
    el.style.top = offset + 'px';
    el.setAttribute('role','alert');
    el.innerHTML = `<div class="d-flex">
        <div class="toast-body">${esc(msg)}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>`;
    document.body.appendChild(el);
    const t = new bootstrap.Toast(el, { delay: 1500 });
    t.show(); setTimeout(()=> el.remove(), 2200);
  }

  // Theme + auth chrome
  (function initChrome(){
    if (localStorage.getItem('theme')==='dark') document.body.classList.add('dark');
    document.getElementById('themeToggle')?.addEventListener('click', ()=>{
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    });
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    if (isLoggedIn()) { loginBtn?.classList.add('d-none'); logoutBtn?.classList.remove('d-none'); }
    logoutBtn?.addEventListener('click', ()=>{ localStorage.removeItem('auth_token'); localStorage.removeItem('auth_email'); location.reload(); });
  })();

  // ----- State -----
  let events = [];
  let current = 1, perPage = 6;
  let view = localStorage.getItem('events_view') || 'grid';
  let activeCat = ''; // from chips
  const favKey = 'favs';
  const getFavs = () => JSON.parse(localStorage.getItem(favKey) || '[]');
  const setFavs = (arr) => localStorage.setItem(favKey, JSON.stringify(arr));
  const isFav = (id) => getFavs().includes(String(id));
  function toggleFav(id){
    const f = new Set(getFavs());
    const s = String(id);
    f.has(s) ? f.delete(s) : f.add(s);
    setFavs([...f]); render(); // re-render to reflect star + filters
  }

  // ----- DOM refs -----
  const grid = document.getElementById('grid');
  const list = document.getElementById('list');
  const q = document.getElementById('q');
  const dateFrom = document.getElementById('dateFrom');
  const dateTo = document.getElementById('dateTo');
  const sort = document.getElementById('sort');
  const favOnly = document.getElementById('favOnly');
  const chips = document.getElementById('chips');
  const page = document.getElementById('page');
  const prev = document.getElementById('prev');
  const next = document.getElementById('next');
  const resultInfo = document.getElementById('resultInfo');
  const viewGrid = document.getElementById('viewGrid');
  const viewList = document.getElementById('viewList');
  const resetBtn = document.getElementById('resetBtn');

  // URL params prefill
  (function prefill(){
    const params = new URLSearchParams(location.search);
    if (params.get('from')) dateFrom.value = params.get('from');
    if (params.get('to'))   dateTo.value   = params.get('to');
    if (params.get('q'))    q.value        = params.get('q');
    if (params.get('cat'))  activeCat      = params.get('cat');
    if (params.get('view')) view           = params.get('view');
    if (params.get('fav')==='1') favOnly.checked = true;
  })();

  // Skeletons while loading
  grid.innerHTML = Array.from({length:6}).map(()=>`
    <div class="col"><div class="card h-100 hoverable">
      <div class="skel h150 rounded-top-2"></div>
      <div class="card-body">
        <div class="skel h20 rounded-8 mb-2"></div>
        <div class="skel h20 rounded-8" style="width:60%"></div>
      </div>
    </div></div>`).join('');

  // Fetch events + init
  fetch('./data/events.json').then(r=>r.json()).then(data=>{
    events = data;
    buildChips();
    setView(view);
    render();
  }).catch(()=>{
    grid.innerHTML = '<div class="col-12"><div class="alert alert-danger">Failed to load events.</div></div>';
  });

  // Build category chips from data
  function buildChips(){
    const cats = [...new Set(events.map(e => e.category).filter(Boolean))].sort();
    chips.innerHTML = [
      `<button type="button" class="btn btn-sm ${activeCat?'btn-outline-secondary':'btn-secondary'} rounded-pill" data-cat="">All</button>`,
      ...cats.map(c => `<button type="button" class="btn btn-sm ${activeCat===c?'btn-secondary':'btn-outline-secondary'} rounded-pill" data-cat="${esc(c)}">${esc(c)}</button>`)
    ].join(' ');
    chips.querySelectorAll('button[data-cat]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        activeCat = btn.getAttribute('data-cat') || '';
        // update chip styles
        chips.querySelectorAll('button[data-cat]').forEach(b=>{
          const isOn = (b.getAttribute('data-cat') || '') === activeCat;
          b.classList.toggle('btn-secondary', isOn);
          b.classList.toggle('btn-outline-secondary', !isOn);
        });
        current = 1; render();
      });
    });
  }

  // Events
  [q, dateFrom, dateTo, sort, favOnly].forEach(el => el.addEventListener('input', ()=> { current = 1; render(); }));
  prev.addEventListener('click', ()=> { if(current>1){ current--; render(); }});
  next.addEventListener('click', ()=> { if(current<maxPage()){ current++; render(); }});
  viewGrid.addEventListener('click', ()=> setView('grid'));
  viewList.addEventListener('click', ()=> setView('list'));
  resetBtn.addEventListener('click', ()=>{
    q.value=''; dateFrom.value=''; dateTo.value='';
    sort.value='date'; favOnly.checked=false; activeCat='';
    buildChips(); current=1; setView('grid'); render();
  });

  function setView(v){
    view = v; localStorage.setItem('events_view', v);
    viewGrid.classList.toggle('active', v==='grid');
    viewList.classList.toggle('active', v==='list');
    render();
  }

  function filtered(){
    const term = q.value.trim().toLowerCase();
    const from = dateFrom.value || null;
    const to   = dateTo.value || null;
    let arr = [...events];
    // sort
    arr.sort((a,b)=> sort.value==='title' ? a.title.localeCompare(b.title) : a.date.localeCompare(b.date));
    // filter
    arr = arr.filter(e=>{
      const byTerm = !term || e.title.toLowerCase().includes(term) || e.venue.toLowerCase().includes(term);
      const byDate = (!from || e.date >= from) && (!to || e.date <= to);
      const byCat  = !activeCat || e.category === activeCat;
      const byFav  = !favOnly.checked || isFav(e.id);
      return byTerm && byDate && byCat && byFav;
    });
    return arr;
  }

  function maxPage(){ return Math.max(1, Math.ceil(filtered().length / perPage)); }

  function render(){
    const items = filtered();
    const start = (current-1)*perPage, end = start + perPage;
    const slice = items.slice(start, end);

    resultInfo.textContent = `${items.length} result${items.length===1?'':'s'}`;
    page.textContent = `Page ${current} / ${maxPage()}`;
    prev.disabled = current<=1;
    next.disabled = current>=maxPage();

    const empty = '<div class="col-12"><div class="text-center text-muted p-5"><i class="bi bi-emoji-frown fs-1"></i><p class="mt-2 mb-0">No events match your filters.</p></div></div>';

    if(view==='grid'){
      list.classList.add('d-none'); grid.classList.remove('d-none');
      grid.innerHTML = slice.map(cardHtml).join('') || empty;
      // bind stars & quick view
      grid.querySelectorAll('[data-star]').forEach(b=> b.addEventListener('click', ()=> toggleFav(b.dataset.star)));
      grid.querySelectorAll('[data-qview]').forEach(b=> b.addEventListener('click', ()=> openQuick(b.dataset.qview)));
    } else {
      grid.classList.add('d-none'); list.classList.remove('d-none');
      list.innerHTML = slice.map(rowHtml).join('') || '<div class="list-group-item text-muted">No events match your filters.</div>';
      list.querySelectorAll('[data-star]').forEach(b=> b.addEventListener('click', (ev)=>{ev.preventDefault(); toggleFav(b.dataset.star)}));
      list.querySelectorAll('[data-qview]').forEach(b=> b.addEventListener('click', (ev)=>{ev.preventDefault(); openQuick(b.dataset.qview)}));
    }
  }

  function cardHtml(e){
    const fav = isFav(e.id);
    return `
      <div class="col">
        <div class="card h-100 hoverable">
          <div class="position-relative">
            <img src="${esc(e.image)}" alt="Poster of ${esc(e.title)}" class="card-img-top" style="object-fit:cover;height:180px">
            <button class="btn btn-sm ${fav?'btn-warning':'btn-outline-warning'} position-absolute top-0 end-0 m-2" data-star="${esc(e.id)}" title="Favorite">
              <i class="bi ${fav?'bi-star-fill':'bi-star'}"></i>
            </button>
          </div>
          <div class="card-body">
            <h5 class="card-title d-flex align-items-center justify-content-between">
              <span>${esc(e.title)}</span>
              <span class="badge bg-secondary ms-2">${esc(e.category || 'General')}</span>
            </h5>
            <p class="card-text text-muted mb-3"><i class="bi bi-geo-alt"></i> ${esc(e.venue)} · ${esc(e.date)}</p>
            <div class="d-flex gap-2">
              <a class="btn btn-sm btn-primary" href="details.html?id=${encodeURIComponent(e.id)}">View</a>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-qview="${esc(e.id)}">Quick View</button>
            </div>
          </div>
        </div>
      </div>`;
  }

  function rowHtml(e){
    const fav = isFav(e.id);
    return `
      <a class="list-group-item list-group-item-action d-flex align-items-center" href="details.html?id=${encodeURIComponent(e.id)}">
        <img src="${esc(e.image)}" alt="Poster of ${esc(e.title)}" class="rounded me-3" style="width:84px;height:56px;object-fit:cover">
        <div class="flex-fill">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-1">${esc(e.title)}</h6>
            <span class="badge bg-secondary">${esc(e.category || 'General')}</span>
          </div>
          <small class="text-muted"><i class="bi bi-geo-alt"></i> ${esc(e.venue)} · ${esc(e.date)}</small>
        </div>
        <div class="ms-3 d-flex align-items-center gap-2">
          <button class="btn btn-sm ${fav?'btn-warning':'btn-outline-warning'}" data-star="${esc(e.id)}" title="Favorite">
            <i class="bi ${fav?'bi-star-fill':'bi-star'}"></i>
          </button>
          <button class="btn btn-sm btn-outline-secondary" data-qview="${esc(e.id)}">Quick</button>
          <i class="bi bi-chevron-right"></i>
        </div>
      </a>`;
  }

  // Quick View modal fill
  const qvModal = new bootstrap.Modal(document.getElementById('quickView'));
  const qvTitle = document.getElementById('quickViewLabel');
  const qvBody  = document.getElementById('quickViewBody');
  const qvLink  = document.getElementById('quickViewLink');

  function openQuick(id){
    const e = events.find(x => String(x.id)===String(id));
    if(!e){ toast('Event not found'); return; }
    qvTitle.textContent = e.title;
    qvBody.innerHTML = `
      <div class="row g-3">
        <div class="col-md-6"><img src="${esc(e.image)}" alt="Poster of ${esc(e.title)}" class="img-fluid rounded"></div>
        <div class="col-md-6">
          <p class="mb-1"><span class="badge bg-secondary">${esc(e.category || 'General')}</span></p>
          <p class="mb-1"><i class="bi bi-calendar2"></i> ${esc(e.date)} ${e.time ? '• '+esc(e.time):''}</p>
          <p class="mb-2"><i class="bi bi-geo-alt"></i> ${esc(e.venue)} ${e.location? '— '+esc(e.location):''}</p>
          <p class="mb-0">${esc(e.description)}</p>
        </div>
      </div>`;
    qvLink.href = `details.html?id=${encodeURIComponent(e.id)}`;
    qvModal.show();
  }
</script>
</body>
</html>
